name: Database Deployment Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Confirm deployment to all environments'
        required: true
        type: boolean
        default: false

jobs:
  # Generate matrix from JSON config
  setup-matrix:
    runs-on: windows-latest
    outputs:
      environments: ${{ steps.create-matrix.outputs.environments }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create deployment matrix
        id: create-matrix
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.confirm_deployment }}" -eq "false") {
            Write-Error "Deployment confirmation required"
            exit 1
          }
          
          # Read JSON configuration
          $config = Get-Content -Path ".github/config/database-config.json" | ConvertFrom-Json
          $allEnvironments = $config.PSObject.Properties.Name
          
          # Create environment array for matrix
          $environmentArray = @()
          foreach ($env in $allEnvironments) {
            $environmentArray += $env
          }
          
          $environmentsJson = $environmentArray | ConvertTo-Json -Compress
          echo "environments=$environmentsJson" >> $env:GITHUB_OUTPUT
          
          Write-Host "Environments to deploy: $($allEnvironments -join ', ')"

  # DEV2 Environment
  approve-dev2:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'DEV2')
    environment: 
      name: DEV2-approval
    steps:
      - name: Approve DEV2 Environment
        run: echo "Approval granted for DEV2 environment"

  deploy-dev2-database1:
    runs-on: windows-latest
    needs: [setup-matrix, approve-dev2]
    if: needs.approve-dev2.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Database1 to DEV2
        run: |
          echo "Deploying Database1 to DEV2"
          # Add your deployment steps here
          # Example: Call your composite action or reusable workflow
          # - uses: ./.github/actions/deploy-database
          #   with:
          #     database-name: Database1
          #     environment: DEV2

  # DEV2ALL Environment  
  approve-dev2all:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'DEV2ALL')
    environment: 
      name: DEV2ALL-approval
    steps:
      - name: Approve DEV2ALL Environment
        run: echo "Approval granted for DEV2ALL environment"

  deploy-dev2all-database1:
    runs-on: windows-latest
    needs: [setup-matrix, approve-dev2all]
    if: needs.approve-dev2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Database1 to DEV2ALL
        run: |
          echo "Deploying Database1 to DEV2ALL"
          # Add your deployment steps here

  deploy-dev2all-database2:
    runs-on: windows-latest
    needs: [setup-matrix, approve-dev2all]
    if: needs.approve-dev2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Database2 to DEV2ALL
        run: |
          echo "Deploying Database2 to DEV2ALL"
          # Add your deployment steps here

  deploy-dev2all-database3:
    runs-on: windows-latest
    needs: [setup-matrix, approve-dev2all]
    if: needs.approve-dev2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Database3 to DEV2ALL
        run: |
          echo "Deploying Database3 to DEV2ALL"
          # Add your deployment steps here

  # QA2ALL Environment
  approve-qa2all:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'QA2ALL')
    environment: 
      name: QA2ALL-approval
    steps:
      - name: Approve QA2ALL Environment
        run: echo "Approval granted for QA2ALL environment"

  deploy-qa2all-databasea:
    runs-on: windows-latest
    needs: [setup-matrix, approve-qa2all]
    if: needs.approve-qa2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseA to QA2ALL
        run: |
          echo "Deploying DatabaseA to QA2ALL"
          # Add your deployment steps here

  deploy-qa2all-databaseb:
    runs-on: windows-latest
    needs: [setup-matrix, approve-qa2all]
    if: needs.approve-qa2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseB to QA2ALL
        run: |
          echo "Deploying DatabaseB to QA2ALL"
          # Add your deployment steps here

  deploy-qa2all-databasec:
    runs-on: windows-latest
    needs: [setup-matrix, approve-qa2all]
    if: needs.approve-qa2all.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseC to QA2ALL
        run: |
          echo "Deploying DatabaseC to QA2ALL"
          # Add your deployment steps here

  # UATEMEAALL Environment
  approve-uatemeaall:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'UATEMEAALL')
    environment: 
      name: UATEMEAALL-approval
    steps:
      - name: Approve UATEMEAALL Environment
        run: echo "Approval granted for UATEMEAALL environment"

  deploy-uatemeaall-databasex:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatemeaall]
    if: needs.approve-uatemeaall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseX to UATEMEAALL
        run: |
          echo "Deploying DatabaseX to UATEMEAALL"
          # Add your deployment steps here

  deploy-uatemeaall-databasey:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatemeaall]
    if: needs.approve-uatemeaall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseY to UATEMEAALL
        run: |
          echo "Deploying DatabaseY to UATEMEAALL"
          # Add your deployment steps here

  # UATNASAALL Environment
  approve-uatnasaall:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'UATNASAALL')
    environment: 
      name: UATNASAALL-approval
    steps:
      - name: Approve UATNASAALL Environment
        run: echo "Approval granted for UATNASAALL environment"

  deploy-uatnasaall-databasep:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatnasaall]
    if: needs.approve-uatnasaall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseP to UATNASAALL
        run: |
          echo "Deploying DatabaseP to UATNASAALL"
          # Add your deployment steps here

  deploy-uatnasaall-databaseq:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatnasaall]
    if: needs.approve-uatnasaall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseQ to UATNASAALL
        run: |
          echo "Deploying DatabaseQ to UATNASAALL"
          # Add your deployment steps here

  deploy-uatnasaall-databaser:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatnasaall]
    if: needs.approve-uatnasaall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseR to UATNASAALL
        run: |
          echo "Deploying DatabaseR to UATNASAALL"
          # Add your deployment steps here

  # UATAPACALL Environment
  approve-uatapacall:
    runs-on: windows-latest
    needs: setup-matrix
    if: contains(fromJson(needs.setup-matrix.outputs.environments), 'UATAPACALL')
    environment: 
      name: UATAPACALL-approval
    steps:
      - name: Approve UATAPACALL Environment
        run: echo "Approval granted for UATAPACALL environment"

  deploy-uatapacall-databasem:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatapacall]
    if: needs.approve-uatapacall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseM to UATAPACALL
        run: |
          echo "Deploying DatabaseM to UATAPACALL"
          # Add your deployment steps here

  deploy-uatapacall-databausen:
    runs-on: windows-latest
    needs: [setup-matrix, approve-uatapacall]
    if: needs.approve-uatapacall.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy DatabaseN to UATAPACALL
        run: |
          echo "Deploying DatabaseN to UATAPACALL"
          # Add your deployment steps here

  # Summary job
  deployment-summary:
    runs-on: windows-latest
    needs: [
      setup-matrix,
      deploy-dev2-database1,
      deploy-dev2all-database1, deploy-dev2all-database2, deploy-dev2all-database3,
      deploy-qa2all-databasea, deploy-qa2all-databaseb, deploy-qa2all-databasec,
      deploy-uatemeaall-databasex, deploy-uatemeaall-databasey,
      deploy-uatnasaall-databasep, deploy-uatnasaall-databaseq, deploy-uatnasaall-databaser,
      deploy-uatapacall-databasem, deploy-uatapacall-databausen
    ]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "Deployment completed for all environments"
          echo "Check individual job results for details"
